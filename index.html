<!DOCTYPE HTML>
<html>
<head>
    <title>ESP8266 Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* seu CSS inteiro aqui (mantido igual) */
        body { 
            font-family: Arial; 
            margin: 0; 
            padding: 20px; 
            background: #2b2b2b; 
            color: #fff; 
        }
        .main-container {
            display: flex;
            gap: 20px;
            height: 400px;
        }
        .terminal-container {
            flex: 2;
        }
        .history-container {
            flex: 1;
            background: #1a1a1a;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .history-header {
            padding: 5px;
            background: #333;
            border-radius: 3px;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-clear {
            background: #444;
            border: none;
            color: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .history-clear:hover {
            background: #555;
        }
        #history-list {
            overflow-y: auto;
            flex: 1;
        }
        .history-item {
            padding: 5px;
            border-bottom: 1px solid #333;
            font-family: monospace;
            font-size: 0.9em;
            cursor: pointer;
        }
        .history-item:hover {
            background: #333;
        }
        .history-timestamp {
            color: #666;
            font-size: 0.8em;
            margin-right: 5px;
        }
        #terminal { 
            background: #000; 
            padding: 10px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            margin-bottom: 10px; 
            border-radius: 5px;
        }
        .input-area { 
            display: flex; 
            gap: 10px; 
        }
        input { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 5px; 
            background: #333; 
            color: #fff; 
        }
        button { 
            padding: 10px 20px; 
            background: #0066cc; 
            border: none; 
            color: white; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { 
            background: #0052a3; 
        }
        .received { 
            color: #00ff00; 
        }
        .sent { 
            color: #ff9900; 
        }
        .system {
            color: #888;
            font-style: italic;
        }
        .header {
            margin-bottom: 20px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 3px;
            background: #444;
        }
        .status.connected {
            background: #006600;
        }
        .status.disconnected {
            background: #660000;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .baudrate-select {
            padding: 5px 10px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .baudrate-select:hover {
            background: #555;
        }
        .baudrate-select option {
            background: #333;
        }
        .view-controls {
            display: flex;
            gap: 5px;
        }
        .control-button {
            padding: 5px 10px;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .control-button:hover {
            background: #555;
        }
        .control-button.active {
            background: #0066cc;
        }
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .stat-item {
            display: flex;
            gap: 5px;
        }
        .stat-label {
            color: #888;
        }

        .hex-view {
            font-family: monospace;
        }
        .hex-view .hex {
            color: #888;
            margin-right: 10px;
        }
        .hex-view .ascii {
            color: #fff;
        }

        /* Novo CSS para o painel do sistema */
        .system-panel, .flash-panel {
            margin-bottom: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .flash-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            padding: 10px;
        }
        
        .flash-section {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
        }
        
        .flash-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: #888;
        }
        
        .flash-input {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .flash-input input {
            flex: 1;
            min-width: 0;
        }
        
        .progress-bar {
            height: 20px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #0066cc;
            width: 0%;
            transition: width 0.3s;
        }

        .pin-map {
            margin-top: 10px;
            overflow-x: auto;
        }

        .pin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .pin-table th,
        .pin-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .pin-table th {
            background: #333;
            color: #fff;
        }

        .pin-table tr:hover {
            background: #2a2a2a;
        }

        .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .status-indicator.protected {
            background: #cc0000;
        }

        .status-indicator.unprotected {
            background: #00cc00;
        }

        .status-indicator.active {
            background: #00cc00;
        }

        .status-indicator.paused {
            background: #cc0000;
        }

        .chip-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            margin-bottom: 10px;
        }

        .chip-info label {
            color: #888;
        }

        .status-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .operation-status {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 3px;
        }

        .chip-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .section-group {
            background: #222;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .section-group h4 {
            margin: 0 0 10px 0;
            color: #888;
            font-size: 0.9em;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .input-group label {
            min-width: 120px;
            color: #888;
        }

        .file-input {
            margin: 10px 0;
        }

        .file-label {
            display: inline-block;
            padding: 5px 10px;
            background: #444;
            border-radius: 3px;
            cursor: pointer;
        }

        .file-input input[type="file"] {
            display: none;
        }

        #selectedFile {
            margin-left: 10px;
            color: #888;
            font-size: 0.9em;
        }

        .progress-container {
            margin: 10px 0;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9em;
            color: #888;
        }

        .status-message {
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .status-message.error {
            background: #660000;
            color: #fff;
        }

        .status-message.success {
            background: #006600;
            color: #fff;
        }

        .hidden {
            display: none;
        }

        select {
            background: #333;
            color: #fff;
            border: none;
            padding: 5px;
            border-radius: 3px;
        }

        .system-toggle {
            width: 100%;
            padding: 10px;
            background: #333;
            border: none;
            color: #fff;
            text-align: left;
            cursor: pointer;
            font-size: 0.9em;
        }

        .system-toggle:hover {
            background: #444;
        }

        .system-content {
            display: none;
            padding: 10px;
            border-top: 1px solid #444;
        }

        .system-content.show {
            display: block;
        }

        .system-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
        }

        .essential-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Aumentar altura do terminal para compensar o painel colapsado */
        #terminal {
            height: 450px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin: 0;">ESP8266 Serial Terminal</h2>
        <div class="controls">
            <select id="baudrate" onchange="changeBaudRate()" class="baudrate-select">
                <option value="1200">1200 baud</option>
                <option value="2400">2400 baud</option>
                <option value="4800">4800 baud</option>
                <option value="9600" selected>9600 baud</option>
                <option value="19200">19200 baud</option>
                <option value="38400">38400 baud</option>
                <option value="57600">57600 baud</option>
                <option value="115200">115200 baud</option>
            </select>
            <div class="essential-controls">
                <button onclick="toggleHexView()" class="control-button" id="hexButton">HEX</button>
                <button onclick="toggleAutoscroll()" class="control-button" id="scrollButton">Auto-scroll</button>
                <div id="connection-status" class="status">Desconectado</div>
            </div>
        </div>
    </div>

    <div class="flash-panel">
        <button onclick="toggleFlashPanel()" class="system-toggle">
            Controle do Flash Memory ▼
        </button>
        <div id="flashControl" class="system-content">
            <div class="flash-controls">
                <div class="flash-section">
                    <h3>Informações do Chip</h3>
                    <div class="chip-info">
                        <div>ID do Chip: <span id="flashId">--</span></div>
                        <div>Fabricante: <span id="flashManuf">--</span></div>
                        <div>Tamanho: <span id="flashSize">8MB (64Mbit)</span></div>
                        <div>Status Register: <span id="flashStatus">--</span></div>
                        <div class="status-group">
                            <div>WP#: <span id="wpStatus" class="status-indicator">Protegido</span></div>
                            <div>HOLD#: <span id="holdStatus" class="status-indicator">Ativo</span></div>
                            <div>WEL: <span id="welStatus" class="status-indicator">Desabilitado</span></div>
                            <div>Busy: <span id="busyStatus" class="status-indicator">Livre</span></div>
                        </div>
                    </div>
                    <div class="chip-controls">
                        <button onclick="readFlashId()" class="control-button">Ler ID</button>
                        <button onclick="readStatus()" class="control-button">Ler Status</button>
                        <button onclick="toggleWriteProtect()" class="control-button" id="wpButton">Alternar WP#</button>
                    </div>
                    <div class="operation-status">
                        <div>Operação Atual: <span id="currentOp">Nenhuma</span></div>
                        <div>Tempo Restante: <span id="remainingTime">--:--</span></div>
                        <div class="progress-bar">
                            <div id="operationProgress" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flash-section">
                    <h3>Mapa de Pinos</h3>
                    <div class="pin-map">
                        <table class="pin-table">
                            <tr>
                                <th>Função</th>
                                <th>GPIO</th>
                                <th>NodeMCU</th>
                            </tr>
                            <tr>
                                <td>CS#</td>
                                <td>GPIO15</td>
                                <td>D8</td>
                            </tr>
                            <tr>
                                <td>MOSI</td>
                                <td>GPIO13</td>
                                <td>D7</td>
                            </tr>
                            <tr>
                                <td>MISO</td>
                                <td>GPIO12</td>
                                <td>D6</td>
                            </tr>
                            <tr>
                                <td>SCK</td>
                                <td>GPIO14</td>
                                <td>D5</td>
                            </tr>
                            <tr>
                                <td>WP#</td>
                                <td>GPIO2</td>
                                <td>D4</td>
                            </tr>
                            <tr>
                                <td>HOLD#</td>
                                <td>GPIO16</td>
                                <td>D0</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="flash-section">
                    <h3>Backup e Restauração</h3>
                    <div class="backup-controls">
                        <div class="section-group">
                            <h4>Backup</h4>
                            <div class="flash-input">
                                <div class="input-group">
                                    <label>Endereço Inicial:</label>
                                    <input type="text" id="backupAddr" placeholder="Endereço (hex)" value="0">
                                </div>
                                <div class="input-group">
                                    <label>Tamanho:</label>
                                    <select id="backupSize">
                                        <option value="4096">4KB (1 Setor)</option>
                                        <option value="32768">32KB (1 Bloco)</option>
                                        <option value="65536">64KB (2 Blocos)</option>
                                        <option value="8388608">8MB (Chip Completo)</option>
                                        <option value="custom">Personalizado...</option>
                                    </select>
                                    <input type="text" id="customBackupSize" placeholder="Tamanho em bytes" class="hidden">
                                </div>
                            </div>
                            <button onclick="backupFlash()" class="control-button">Fazer Backup</button>
                        </div>
                        
                        <div class="section-group">
                            <h4>Restauração</h4>
                            <div class="flash-input">
                                <div class="input-group">
                                    <label>Endereço Destino:</label>
                                    <input type="text" id="restoreAddr" placeholder="Endereço (hex)" value="0">
                                </div>
                                <div class="file-input">
                                    <label for="restoreFile" class="file-label">Selecionar Arquivo</label>
                                    <input type="file" id="restoreFile" accept=".bin">
                                    <span id="selectedFile">Nenhum arquivo selecionado</span>
                                </div>
                            </div>
                            <button onclick="restoreBackup()" class="control-button">Restaurar Backup</button>
                        </div>
                        
                        <div class="operation-info">
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div id="backupProgress" class="progress-fill"></div>
                                </div>
                                <div class="progress-stats">
                                    <span id="transferSpeed">0 KB/s</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                            </div>
                            <div id="backupStatus" class="status-message"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flash-section">
                    <h3>Operações de Memória</h3>
                    <div class="flash-input">
                        <input type="text" id="eraseAddr" placeholder="Endereço (hex)" value="0">
                    </div>
                    <button onclick="eraseSector()" class="control-button">Apagar Setor</button>
                    <button onclick="eraseBlock()" class="control-button">Apagar Bloco</button>
                    <button onclick="eraseChip()" class="control-button">Apagar Chip</button>
                </div>
                
                <div class="flash-section">
                    <h3>Escrita de Dados</h3>
                    <div class="flash-input">
                        <input type="text" id="writeAddr" placeholder="Endereço (hex)" value="0">
                    </div>
                    <div class="flash-input">
                        <input type="text" id="writeData" placeholder="Dados (hex)">
                    </div>
                    <button onclick="writeData()" class="control-button">Escrever</button>
                </div>
            </div>
        </div>
    </div>

    <div class="system-panel">
        <button onclick="toggleSystemPanel()" class="system-toggle">
            Configurações do Sistema ▼
        </button>
        <div id="systemInfo" class="system-content">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Bytes Recebidos:</span>
                    <span id="bytesReceived">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Última Mensagem:</span>
                    <span id="lastMessageTime">--:--:--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Mensagens/s:</span>
                    <span id="messagesPerSecond">0</span>
                </div>
            </div>
            <div class="system-controls">
                <button onclick="exportData()" class="control-button">Exportar Log</button>
                <button onclick="startFirmwareDump()" class="control-button" id="dumpButton">Dump Firmware</button>
                <button onclick="clearTerminal()" class="control-button">Limpar Terminal</button>
            </div>
        </div>
    </div>
    <div class="main-container">
        <div class="terminal-container">
            <div id="terminal"></div>
            <div class="input-area">
                <input type="text" id="commandInput" placeholder="Digite um comando...">
                <button onclick="sendCommand()">Enviar</button>
            </div>
        </div>
        <div class="history-container">
            <div class="history-header">
                <span>Histórico de Dados</span>
                <button class="history-clear" onclick="clearHistory()">Limpar</button>
            </div>
            <div id="history-list"></div>
        </div>
    </div>
    <script>
        var gateway = `ws://${window.location.hostname}:81/`;
        var websocket;
        var reconnectInterval = null;
        var historyData = [];
        var currentBackup = null;
        var isBackupInProgress = false;
        
        const CONFIG = {
            maxHistorySize: 100,
            maxMessageSize: 1024 * 1024,
            dumpChunkSize: 256,
            maxTerminalMessages: 1000,
            reconnectDelay: 2000,
            statsUpdateInterval: 1000,
        };

        const state = {
            isHexView: false,
            autoScroll: true,
            bytesReceived: 0,
            messagesLastSecond: 0,
            lastMessageTime: new Date(),
            isDumping: false,
            dumpStartAddress: 0,
            totalBytesReceived: 0
        };
        
        function changeBaudRate() {
            const baudrate = document.getElementById('baudrate').value;
            websocket.send(`@BAUD=${baudrate}`);
            addToTerminal(`Alterando baudrate para ${baudrate}...`, 'system');
        }

        window.addEventListener('load', onLoad);

        function onLoad(event) {
            initDOMCache();
            initWebSocket();
            startStatistics();
            
            document.getElementById('commandInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendCommand();
                }
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.textContent = 'Conectado';
                status.className = 'status connected';
            } else {
                status.textContent = 'Desconectado';
                status.className = 'status disconnected';
            }
        }

        function initWebSocket() {
            console.log('Tentando abrir conexão WebSocket...');
            websocket = new WebSocket(gateway);
            websocket.onopen    = onOpen;
            websocket.onclose   = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Conexão estabelecida');
            updateConnectionStatus(true);
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
        }

        function onClose(event) {
            console.log('Conexão fechada');
            updateConnectionStatus(false);
            if (!reconnectInterval) {
                reconnectInterval = setInterval(initWebSocket, 2000);
            }
        }

        function onMessage(event) {
            addToTerminal(event.data, 'received');
            addToHistory(event.data);
        }

        function addToHistory(message) {
            const timestamp = new Date().toLocaleTimeString();
            historyData.unshift({ timestamp, message });
            
            if (historyData.length > CONFIG.maxHistorySize) {
                historyData.pop();
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const fragment = document.createDocumentFragment();
            
            historyData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                const timestamp = document.createElement('span');
                timestamp.className = 'history-timestamp';
                timestamp.textContent = `[${item.timestamp}]`;
                
                const messageText = document.createElement('span');
                messageText.textContent = item.message;
                
                div.appendChild(timestamp);
                div.appendChild(messageText);
                
                div.onclick = () => {
                    domElements.commandInput.value = item.message;
                };
                fragment.appendChild(div);
            });
            
            domElements.historyList.innerHTML = '';
            domElements.historyList.appendChild(fragment);
        }

        function clearHistory() {
            historyData = [];
            updateHistoryDisplay();
        }

        // Funções de controle do Flash Memory
        function toggleFlashPanel() {
            const panel = document.getElementById('flashControl');
            const toggle = document.querySelector('.flash-panel .system-toggle');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                toggle.textContent = 'Controle do Flash Memory ▼';
            } else {
                panel.classList.add('show');
                toggle.textContent = 'Controle do Flash Memory ▲';
            }
        }

        function readFlashId() {
            websocket.send('@READ_ID');
        }

        function toggleWriteProtect() {
            websocket.send('@TOGGLE_WP');
        }

        function updatePinStatus(wp, hold) {
            const wpStatus = document.getElementById('wpStatus');
            const holdStatus = document.getElementById('holdStatus');
            const wpButton = document.getElementById('wpButton');

            wpStatus.textContent = wp ? 'Protegido' : 'Desprotegido';
            wpStatus.className = 'status-indicator ' + (wp ? 'protected' : 'unprotected');
            
            holdStatus.textContent = hold ? 'Ativo' : 'Pausado';
            holdStatus.className = 'status-indicator ' + (hold ? 'active' : 'paused');

            wpButton.textContent = wp ? 'Desativar Proteção' : 'Ativar Proteção';
        }

        async function backupFlash() {
            if (isBackupInProgress) return;
            
            const addr = parseInt(document.getElementById('backupAddr').value, 16);
            const size = parseInt(document.getElementById('backupSize').value);
            
            if (isNaN(addr) || isNaN(size)) {
                addToTerminal('Erro: endereço ou tamanho inválido', 'system');
                return;
            }
            
            isBackupInProgress = true;
            currentBackup = new Uint8Array(size);
            let progress = 0;
            
            for (let offset = 0; offset < size; offset += 256) {
                const chunk = Math.min(256, size - offset);
                websocket.send(`@DUMP=${(addr + offset).toString(16)},${chunk}`);
                await new Promise(resolve => setTimeout(resolve, 100));
                
                progress = (offset + chunk) / size * 100;
                document.getElementById('backupProgress').style.width = progress + '%';
            }
            
            // Cria arquivo de backup
            const blob = new Blob([currentBackup], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flash_backup_${addr.toString(16)}_${size}_${new Date().toISOString().slice(0,10)}.bin`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            isBackupInProgress = false;
            document.getElementById('backupProgress').style.width = '0%';
            addToTerminal(`Backup completo: ${size} bytes`, 'system');
        }

        function eraseSector() {
            const addr = parseInt(document.getElementById('eraseAddr').value, 16);
            if (isNaN(addr)) {
                addToTerminal('Erro: endereço inválido', 'system');
                return;
            }
            if (!confirm('Confirma apagar o setor? Esta operação não pode ser desfeita.')) return;
            websocket.send(`@ERASE_SECTOR=${addr.toString(16)}`);
        }

        function eraseBlock() {
            const addr = parseInt(document.getElementById('eraseAddr').value, 16);
            if (isNaN(addr)) {
                addToTerminal('Erro: endereço inválido', 'system');
                return;
            }
            if (!confirm('Confirma apagar o bloco? Esta operação não pode ser desfeita.')) return;
            websocket.send(`@ERASE_BLOCK=${addr.toString(16)}`);
        }

        function eraseChip() {
            if (!confirm('ATENÇÃO: Isto irá apagar TODO o conteúdo do chip! Continuar?')) return;
            if (!confirm('Tem certeza? Esta operação não pode ser desfeita!')) return;
            websocket.send('@ERASE_CHIP');
        }

        function writeData() {
            const addrInput = document.getElementById('writeAddr').value.trim();
            const dataInput = document.getElementById('writeData').value.trim();
            
            // Validação rigorosa do endereço
            if (!/^[0-9A-Fa-f]+$/.test(addrInput)) {
                addToTerminal('Erro: endereço deve conter apenas dígitos hexadecimais', 'system');
                return;
            }
            
            const addr = parseInt(addrInput, 16);
            if (addr >= 0x800000) { // 8MB
                addToTerminal('Erro: endereço fora dos limites do chip', 'system');
                return;
            }
            
            // Validação rigorosa dos dados
            if (!/^[0-9A-Fa-f]+$/.test(dataInput)) {
                addToTerminal('Erro: dados devem conter apenas dígitos hexadecimais', 'system');
                return;
            }
            
            const data = dataInput;
            
            if (data.length % 2 !== 0) {
                addToTerminal('Erro: quantidade de dados deve ser par', 'system');
                return;
            }
            
            if (data.length > 512) { // 256 bytes em hex
                addToTerminal('Erro: máximo de 256 bytes por vez', 'system');
                return;
            }
            
            const len = data.length / 2;
            websocket.send(`@WRITE=${addr.toString(16)},${len},${data}`);
        }

        function toggleSystemPanel() {
            const panel = document.getElementById('systemInfo');
            const toggle = document.querySelector('.system-toggle');
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                toggle.textContent = 'Configurações do Sistema ▼';
            } else {
                panel.classList.add('show');
                toggle.textContent = 'Configurações do Sistema ▲';
            }
        }

        function clearTerminal() {
            domElements.terminal.innerHTML = '';
            state.bytesReceived = 0;
            state.totalBytesReceived = 0;
            domElements.bytesReceived.textContent = '0';
            addToTerminal('Terminal limpo', 'system');
        }

        function sendCommand() {
            var cmd = document.getElementById('commandInput').value;
            if (cmd) {
                websocket.send(cmd);
                addToTerminal('> ' + cmd, 'sent');
                document.getElementById('commandInput').value = '';
            }
        }

        const domElements = {
            terminal: null,
            bytesReceived: null,
            lastMessageTime: null,
            messagesPerSecond: null,
            commandInput: null,
            historyList: null
        };

        function initDOMCache() {
            domElements.terminal = document.getElementById('terminal');
            domElements.bytesReceived = document.getElementById('bytesReceived');
            domElements.lastMessageTime = document.getElementById('lastMessageTime');
            domElements.messagesPerSecond = document.getElementById('messagesPerSecond');
            domElements.commandInput = document.getElementById('commandInput');
            domElements.historyList = document.getElementById('history-list');
        }

        function startStatistics() {
            setInterval(() => {
                domElements.messagesPerSecond.textContent = state.messagesLastSecond;
                state.messagesLastSecond = 0;
            }, CONFIG.statsUpdateInterval);
        }

        function toggleHexView() {
            state.isHexView = !state.isHexView;
            document.getElementById('hexButton').classList.toggle('active');
            
            const fragment = document.createDocumentFragment();
            Array.from(domElements.terminal.children).forEach(msg => {
                const newLine = createTerminalLine(msg.textContent, msg.className);
                fragment.appendChild(newLine);
            });
            
            domElements.terminal.innerHTML = '';
            domElements.terminal.appendChild(fragment);
        }

        function toggleAutoscroll() {
            state.autoScroll = !state.autoScroll;
            document.getElementById('scrollButton').classList.toggle('active');
        }

        function exportData() {
            const data = historyData.map(item => 
                `[${item.timestamp}] ${item.message}`
            ).join('\n');
            
            const blob = new Blob([data], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `terminal-log-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        let firmwareChunks = [];
        let isDumping = false;
        let dumpStartAddress = 0;
        let totalBytesReceived = 0;

        function startFirmwareDump() {
            if (isDumping) {
                addToTerminal('Dump já em andamento...', 'system');
                return;
            }

            const dumpButton = document.getElementById('dumpButton');
            dumpButton.classList.add('active');
            isDumping = true;
            firmwareChunks = [];
            dumpStartAddress = 0;
            totalBytesReceived = 0;

            addToTerminal('Iniciando dump do firmware...', 'system');
            requestNextChunk();
        }

        function requestNextChunk() {
            if (!isDumping) return;
            
            websocket.send(`@DUMP=${dumpStartAddress.toString(16)},${CONFIG.dumpChunkSize}`);
            addToTerminal(`Solicitando chunk de memória: 0x${dumpStartAddress.toString(16)}`, 'system');
        }

        function processDumpResponse(data) {
            const parts = data.split(':');
            if (parts.length !== 4 || parts[0] !== '@DUMP') {
                return false;
            }

            const addr = parseInt(parts[1], 16);
            const size = parseInt(parts[2]);
            const hexData = parts[3];

            const bytes = new Uint8Array(hexData.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            firmwareChunks.push(bytes);
            totalBytesReceived += bytes.length;

            addToTerminal(`Recebido chunk de 0x${addr.toString(16)} (${bytes.length} bytes)`, 'system');

            if (bytes.length === 0 || totalBytesReceived >= 1024*1024) {
                finishDump();
            } else {
                dumpStartAddress += bytes.length;
                setTimeout(requestNextChunk, 100);
            }

            return true;
        }

        function finishDump() {
            isDumping = false;
            document.getElementById('dumpButton').classList.remove('active');

            const totalLength = firmwareChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            const fullArray = new Uint8Array(totalLength);
            let offset = 0;
            for (const chunk of firmwareChunks) {
                fullArray.set(chunk, offset);
                offset += chunk.length;
            }

            const blob = new Blob([fullArray], { type: 'application/octet-stream' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firmware-dump-${new Date().toISOString().slice(0,10)}.bin`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addToTerminal(`Dump completo! Total de ${totalBytesReceived} bytes salvos.`, 'system');
        }

        function toHex(str) {
            let hex = '';
            let ascii = '';
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                hex += charCode.toString(16).padStart(2, '0') + ' ';
                ascii += (charCode >= 32 && charCode <= 126) ? str[i] : '.';
            }
            return `<span class="hex">${hex}</span><span class="ascii">${ascii}</span>`;
        }

        function createTerminalLine(message, type) {
            const line = document.createElement('div');
            line.className = type;
            
            if (type === 'received') {
                if (state.isHexView) {
                    line.className += ' hex-view';
                    const hexView = toHex(message);
                    const hexSpan = document.createElement('span');
                    hexSpan.className = 'hex';
                    hexSpan.textContent = hexView.hex;
                    
                    const asciiSpan = document.createElement('span');
                    asciiSpan.className = 'ascii';
                    asciiSpan.textContent = hexView.ascii;
                    
                    line.appendChild(hexSpan);
                    line.appendChild(asciiSpan);
                } else {
                    const safeText = document.createTextNode(message);
                    line.appendChild(safeText);
                }
            } else {
                const safeText = document.createTextNode(message);
                line.appendChild(safeText);
            }
            
            return line;
        }
        
        function toHex(str) {
            let hex = '';
            let ascii = '';
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                hex += charCode.toString(16).padStart(2, '0') + ' ';
                ascii += (charCode >= 32 && charCode <= 126) ? str[i] : '.';
            }
            return { hex, ascii };
        }

        function addToTerminal(message, type) {
            // Corrige recebimento de caracteres quebrados/incompletos
            if (typeof message === 'string') {
                message = message.replace(/\r/g, '\n');
            }
            state.bytesReceived += message.length;
            state.totalBytesReceived += message.length;
            state.lastMessageTime = new Date();
            if (type === 'received') {
                state.messagesLastSecond++;
                domElements.bytesReceived.textContent = state.bytesReceived;
                domElements.lastMessageTime.textContent = state.lastMessageTime.toLocaleTimeString();
            }
            const line = createTerminalLine(message, type);
            const fragment = document.createDocumentFragment();
            fragment.appendChild(line);
            domElements.terminal.appendChild(fragment);
            if (state.autoScroll) {
                domElements.terminal.scrollTop = domElements.terminal.scrollHeight;
            }
            while (domElements.terminal.children.length > CONFIG.maxTerminalMessages) {
                domElements.terminal.removeChild(domElements.terminal.firstChild);
            }
        }
    </script>
</body>
</html>
)rawliteral";